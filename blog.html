<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIU Forum</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="blog.css">
    <link rel="icon" type="image/x-icon" href="assets/diu-logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="config.js"></script>
</head>

<body class="page-with-header">
    <header class="header subpage-header">
        <nav class="navbar">
            <div class="nav-left">
                <a href="index.html" class="logo">
                    <i class="fas fa-graduation-cap"></i>
                    <span>DIU Forum</span>
                </a>
            </div>
            <div class="nav-center">
                <a href="index.html" class="nav-link">Home</a>
                <a href="blog.html" class="nav-link active">Blogs</a>
                <a href="jobs.html" class="nav-link">Jobs</a>
                <a href="studies.html" class="nav-link">Higher Studies</a>
            </div>
            <div class="nav-right">
                <div class="user-menu-card">
                    <div class="user-menu">
                        <div class="user-profile">
                            <span id="userName">Guest User</span>
                            <img id="navUserAvatarImg" class="user-avatar-img" alt="User" />
                            <i id="navUserIcon" class="fas fa-user-circle user-icon"></i>
                        </div>
                        <div class="dropdown" id="userDropdown">
                            <div id="dropdownLogin">
                                <a href="#" class="sign-in-btn"><i class="fas fa-sign-in-alt"></i> Login</a>
                            </div>
                            <div id="dropdownLogout" class="hidden">
                                <a href="#" class="sign-out-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                            </div>
                            <a href="settings.html"><i class="fas fa-cog"></i>Settings</a>
                            <a href="help.html"><i class="fa-solid fa-circle-question"></i>Help</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="blog-layout">
        <!-- Left Sidebar -->
        <aside class="left-sidebar">
            <!-- User Profile Card -->
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar" id="userAvatar"
                        style="position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                        <img id="userAvatarImg" alt="Profile"
                            style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;" />
                        <span id="userAvatarLetter">U</span>
                    </div>
                    <div class="profile-info">
                        <h3 id="profileName">User Name</h3>
                        <p id="profileType">Student</p>
                        <p id="profileDepartment">Computer Science</p>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="quick-links-card">
                <h4>Quick Links</h4>
                <ul class="quick-links">
                    <li><a href="https://skill.jobs/browse-jobs"><i class="fas fa-briefcase"></i>Skill Jobs</a></li>
                    <li><a href="https://daffodilvarsity.edu.bd/"><i class="fas fa-graduation-cap"></i>DIU Official Site</a></li>
                    <li><a href="https://daffodilvarsity.edu.bd/noticeboard"><i class="fas fa-calendar"></i>DIU Notice Board</a></li>
                    <li><a href="https://studentportal.diu.edu.bd/"><i class="fas fa-users"></i>Student Portal</a></li>
                    <li><a href="https://teacherportal.diu.edu.bd/"><i class="fa-solid fa-chalkboard-user"></i>Teacher Portal</a></li>
                    <li><a href="https://pd.daffodilvarsity.edu.bd/support_ticket"><i class="fa-solid fa-ticket"></i>DIU Support Ticket</a></li>
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Create Post Section -->
            <div class="create-post-card">
                <div class="create-post-header">
                    <div class="user-avatar-small" id="createPostAvatar">U</div>
                    <button class="create-post-btn" id="newPostBtn">
                        <span>What's on your mind?</span>
                    </button>
                </div>
            </div>

            <!-- Posts Feed -->
            <div class="posts-feed" id="postsContainer">
                <div class="loading" id="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading posts...</p>
                </div>
            </div>
        </main>

        <!-- Post Card Template (used by posts.js) -->
        <template id="postTemplate">
            <article class="post-card">
                <div class="post-header">
                    <div class="author-info">
                        <div class="author-avatar" data-author-avatar>
                            <img data-author-avatar-img alt="Author avatar" />
                            <span class="author-avatar-letter">U</span>
                        </div>
                        <div class="author-details">
                            <div class="author-name">
                                <span data-author-name></span><span class="author-meta" data-author-meta
                                    style="display:none;"></span>
                            </div>
                            <div class="post-time" data-post-time></div>
                        </div>
                    </div>
                    <div class="post-menu">
                        <button class="post-menu-toggle" data-post-menu-toggle aria-label="Post actions">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div class="post-menu-dropdown" data-post-menu>
                            <button class="post-menu-item" data-menu-action="contact">
                                <i class="fas fa-address-card"></i>
                                <span>View contact info</span>
                            </button>
                            <button class="post-menu-item" data-menu-action="copy">
                                <i class="fas fa-link"></i>
                                <span>Copy post link</span>
                            </button>
                            <button class="post-menu-item" data-menu-action="edit">
                                <i class="fas fa-pen"></i>
                                <span>Edit post</span>
                            </button>
                            <button class="post-menu-item is-destructive" data-menu-action="delete">
                                <i class="fas fa-trash"></i>
                                <span>Delete post</span>
                            </button>
                            <button class="post-menu-item is-destructive" data-menu-action="report">
                                <i class="fas fa-flag"></i>
                                <span>Report post</span>
                            </button>
                        </div>
                    </div>
                </div>
                <h4 class="post-title" data-post-heading style="display:none;"></h4>
                <div class="post-content" data-post-content></div>
                <div class="post-attachments" data-post-attachments style="display:none;"></div>
                <div class="post-footer">
                    <div class="post-contacts" data-post-contacts style="display:none;"></div>
                    <div class="post-actions">
                        <button class="like-btn" data-like-btn title="Like">
                            <i class="fas fa-heart"></i>
                            <span data-like-count>0</span>
                        </button>
                        <button class="comment-btn" data-comment-btn title="Comments">
                            <i class="fas fa-comment"></i>
                            <span data-comment-count>0</span>
                        </button>
                        <button class="share-btn" data-share-btn title="Share">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>
            </article>
        </template>

    <!-- Inline comments area template -->
    <template id="commentsTemplate">
        <div class="comments-panel comments-panel-compact" data-comments-panel style="display:none;">
            <div class="comments-header">
                <div>
                    <p class="comments-title">Discussion</p>
                </div>
                <div class="comments-count-pill" data-comments-count>0</div>
            </div>
            <div class="comments-list" data-comments-list></div>
            <div class="comments-empty" data-comments-empty>Be the first to share a comment.</div>
            <div class="comments-status" data-comments-status style="display:none;"></div>
            <form class="comments-form" data-comments-form>
                <div class="comment-input-row">
                    <div class="comment-input-avatar" data-comment-avatar>
                        <img data-comment-avatar-img alt="Your avatar" />
                        <span class="comment-avatar-letter">U</span>
                    </div>
                    <div class="comment-input-fields">
                        <textarea name="content" rows="2" placeholder="Write a thoughtful comment..." required></textarea>
                        <div class="comment-input-actions">
                            <button type="submit" class="comment-submit">
                                <i class="fas fa-paper-plane"></i>
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </template>

    </div>
    <!-- Post Creation Modal -->
    <div id="postModal" class="modal-overlay">
        <div class="post-modal-card">
            <h3 id="postModalTitle" class="modal-title">Create Post</h3>
            <div id="postUserInfo" class="post-modal-userinfo">Signed in as <span id="postAuthorName"></span></div>
            <div class="post-modal-body">
                <div class="form-field">
                    <label for="postHeading">Heading<span class="required"> *</span></label>
                    <input id="postHeading" class="pm-input" type="text" maxlength="120" placeholder="Concise, descriptive title" />
                </div>
                <div class="form-field">
                    <label for="postContent">Main Post<span class="required"> *</span></label>
                    <textarea id="postContent" class="pm-textarea" rows="6" placeholder="Share something with the community..."></textarea>
                </div>
                <div class="post-modal-attachments">
                    <div class="attachment-actions">
                        <button id="addPhotoBtn" class="pm-attach-btn">
                            <i class="fas fa-image"></i> Photo(s)
                        </button>
                        <button id="addVideoBtn" class="pm-attach-btn">
                            <i class="fas fa-video"></i> Video(s)
                        </button>
                        <span class="pm-note">(Preview & uploads coming soon)</span>
                    </div>
                    <input id="postImages" type="file" accept="image/*" multiple class="hidden-input" />
                    <input id="postVideos" type="file" accept="video/*" multiple class="hidden-input" />
                    <div id="attachmentList" class="attachment-list"></div>
                </div>
                <!-- Contacts Section -->
                <div class="form-field">
                    <label for="contactEmail">Contact Email</label>
                    <input id="contactEmail" class="pm-input" type="email" placeholder="you@example.com" readonly />
                    <div class="pm-note">This email will be shown on your post so others can reach you.</div>
                </div>
                <div class="form-field">
                    <label for="contactOther">Other Contact (optional)</label>
                    <input id="contactOther" class="pm-input" type="text" maxlength="160" placeholder="Phone number, Telegram link, Facebook, LinkedIn, etc." />
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancelPostBtn" class="pm-btn pm-btn-secondary">Cancel</button>
                <button id="submitPostBtn" class="pm-btn pm-btn-primary">Post</button>
            </div>
            <div id="postError" class="post-error"></div>
            <div id="profileIncompleteMsg" class="profile-incomplete">
                Complete your profile (Display Name, Role, Department, Institution) in <a href="settings.html" class="link-accent">Settings</a> to post.
            </div>
        </div>
    </div>
    <!-- Contact Info Modal -->
    <div id="contactModal" class="modal-overlay">
        <div class="post-modal-card contact-card">
            <h3 class="modal-title">Contact Info</h3>
            <div id="contactDetails" class="post-contacts" style="margin-top:8px;"></div>
            <div class="modal-actions">
                <button id="closeContactBtn" class="pm-btn pm-btn-secondary">Close</button>
            </div>
        </div>
    </div>
    <script type="module" src="auth.js"></script>
    <script>
        // Require authentication to view blog feed. If no user, start sign-in and return here.
        (async function() {
            try {
                // wait briefly for auth.js to initialize
                await new Promise(r => setTimeout(r, 300));
                const user = await window.getCurrentUser?.();
                if (!user) {
                    const target = window.location.href;
                    try {
                        // try direct redirect sign-in
                        await window.signInAndRedirect?.(target);
                    } catch (e) {
                        // fallback: save return path and do normal sign-in
                        try { localStorage.setItem('auth_return_to', target); } catch(_){}
                        await window.signInWithGoogle?.();
                    }
                }
            } catch (err) {
                console.warn('blog auth check failed', err);
            }
        })();
    </script>
    <script type="module" src="posts.js"></script>
</body>

</html>